!function(){function e(){this.partnerName=Insider.partner.name,this.storageName="insdrSubsId",this.localStorage="storageData",this.webPushStorageKey="ins-wp-storage",this.debug=!0,this.tokenCollectorUrl="https://carrier.useinsider.com/v2/web-push/token-collector",this.hitApiUrl=Insider.utils.enumExposer.hitApiUrl,this.swPath=Insider.webPushState.nativeOptInSDKCustomPath?Insider.webPushState.nativeOptInSDKCustomPath:"/insider-sw-sdk.js",this.VAPIDPublicKey=Insider.webPushState.VAPIDPublicKey,this.isVAPIDActive=!Insider.fns.isEmptyString(this.VAPIDPublicKey),this.storagePayloadComplete="insdrPayloadComplete",this.storageSubscriptionCreateDate="insdrSubsIdCreateDate",this.storageIsVAPID="isVAPID",this.registeredWorkerPath="migratedSDK",this.cookies={},this.DBName="INSIDER_WEB_PUSH_DB",this.tableName="settings",this.hasServiceWorkerSupport="serviceWorker"in navigator,this.hasPush="PushManager"in window||"push"in navigator,this.events={CORE:"nativeSdk:permission:",PROMPTED:"prompted",GRANTED:"granted",DENIED:"denied"},this.classes={optInNativeDialog:"insider-opt-in-native-dialog",optInOverlay:"insider-opt-in-overlay",optInOverlayMessage:"insider-opt-in-overlay-message",optInInstructionWrapper:"insider-opt-in-instruction-wrapper",optInInstruction:"insider-opt-in-instruction",optInInstructionClose:"insider-opt-in-instruction-close",optInInstructionImage:"insider-opt-in-instruction-image",optInInstructionMessage:"insider-opt-in-instruction-message"},this.lastSwRegistrationError="lastSwRegistrationError"}e.prototype.initialize=function(){return Insider.worker.pm({type:"initializePushStateCookies",success:function(e){this.cookies=e,this.debug=this.checkFromStorage("insider-push-debug","true"),this.initializeIndexedDB(function(e){e&&(Insider.indexedDB.save(this.tableName,{id:1,name:"partnerName",value:this.partnerName}),Insider.indexedDB.save(this.tableName,{id:2,name:"spUID",value:Insider.getUserId()}),Insider.indexedDB.save(this.tableName,{id:3,name:"lastReceivedWebPushes",value:[]}))}.bind(this)),this.debug&&(console.log("Initializing Native SDK"),console.log("Push Manager Support:",this.hasPush)),this.hasPush&&(this.saveImpressionLog(),this.storeRegisterRequest(),this.grantPermission())}.bind(this)}),Insider.eventManager.dispatch(this.events.CORE+this.events.PROMPTED),!0},e.prototype.initializeIndexedDB=function(e){return Insider.indexedDB.connect(this.DBName,this.tableName,(function(t){e(t)})),!0},e.prototype.saveImpressionLog=function(){return!this.checkFromStorage("native-permission-impression","true")&&(this.addToStorage("native-permission-impression","true",360),new Insider.log("w",{t:"storeLog",type:"webPush",logType:"native-permission-impression",browser:Insider.browser.name,isMobile:Insider.browser.isMobile(),userID:Insider.getUserId(),language:Insider.systemRules.call("getLang")}).send(),!0)},e.prototype.storeRegisterRequest=function(){return!this.checkFromStorage("push-request-sent","true")&&(new Insider.log("w",{t:"storeLog",type:"webPush",logType:"push-request",browser:Insider.browser.name,isMobile:Insider.browser.isMobile(),userID:Insider.getUserId(),language:Insider.systemRules.call("getLang")}).send(),!0)},e.prototype.grantPermission=function(){return this.appendOverlay(),this.appendInstructionMessage(),Notification.requestPermission().then(this.handlePermissionAction.bind(this)),!0},e.prototype.appendOverlay=function(){if(!window.insiderOptInOverlayIsActive)return!1;var e=Insider.dom().create("div",{id:this.classes.optInNativeDialog});return e.append(Insider.dom().create("div",{className:this.classes.optInOverlay})),e.append(Insider.dom().create("div",{className:this.classes.optInOverlayMessage}).text(window.insiderOptInOverlayMessage)),Insider.dom("body").append(e),Insider.eventManager.on("click","."+this.classes.optInOverlay,this.removeOverlayAndInstruction.bind(this)),!0},e.prototype.appendInstructionMessage=function(){return!!window.insiderOptInInstructionMessageIsActive&&(Insider.dom("body").append(this.getInstructionMessageElement()),Insider.eventManager.on("click","."+this.classes.optInInstruction,this.removeOverlayAndInstruction.bind(this)),!0)},e.prototype.getInstructionMessageElement=function(){var e=Insider.dom().create("div",{id:this.classes.optInInstructionWrapper,className:this.classes.optInInstruction});return e.append(Insider.dom().create("div",{className:this.classes.optInInstructionClose})).append(Insider.dom().create("div",{className:this.classes.optInInstructionImage}).append(Insider.dom().create("img",{src:window.insiderOptInInstructionImage}))),e.append(Insider.dom().create("div",{className:this.classes.optInInstructionMessage}).text(window.insiderOptInInstructionMessage)),e},e.prototype.handlePermissionAction=function(e){return this.removeOverlayAndInstruction(),!window.isRequestPermission&&"default"!==e&&(window.isRequestPermission=!0,"granted"!==e?(Insider.eventManager.dispatch(this.events.CORE+this.events.DENIED),!1):(Insider.eventManager.dispatch(this.events.CORE+this.events.GRANTED),this.registerServiceWorker(),!0))},e.prototype.removeOverlayAndInstruction=function(){return!(!window.insiderOptInOverlayIsActive&&!window.insiderOptInInstructionMessageIsActive||(window.insiderOptInOverlayIsActive&&Insider.dom("#"+this.classes.optInNativeDialog).remove(),window.insiderOptInInstructionMessageIsActive&&Insider.dom("#"+this.classes.optInInstructionWrapper).remove(),0))},e.prototype.registerServiceWorker=function(){return navigator.serviceWorker.register(this.swPath).then(this.handleRegistrationEvent.bind(this)).catch(function(e){const t=e.stack||e.message;this.isEqualToLastError(t)||(this.setLastSwRegistrationError(t),this.sendLogToTokenCollector(t)),this.handleException(e)}.bind(this)),Insider.worker.pm({type:"unregisterCustomOptInServiceWorker"}),!0},e.prototype.handleException=function(e){var t=Number(Insider.webPushState.nativeOptInCookieSettings.permissionAbandonExpireDay);return"denied"===Notification.permission&&(t=Number(Insider.webPushState.nativeOptInCookieSettings.permissionBlockExpireDay)),this.setUserPermissionGranted({pushRequestSent:!0}),this.addToStorage("push-request-sent","true",t),this.debug&&console.log(e),this.removeOverlayAndInstruction(),!0},e.prototype.handleRegistrationEvent=function(e){return e.addEventListener("updatefound",function(t){var s=t.target.installing;s.addEventListener("statechange",function(){"activated"===s.state&&this.subscribe(e)}.bind(this))}.bind(this)),this.instantSubscribe(e),!0},e.prototype.subscribe=function(e){var t={userVisibleOnly:!0};return this.isVAPIDActive&&(t.applicationServerKey=this.convertVapidKeyToInt8Array(),this.addToStorage(this.storageIsVAPID,"true",360)),e.pushManager.subscribe(t).then(this.saveSubscription.bind(this)).catch((function(e){console.log("Error occurred while subscribing existing registration: ",e),Insider.fns.has(e.message,"applicationServerKey")&&this.hasServiceWorkerSupport&&navigator.serviceWorker.getRegistration().then(function(e){Insider.fns.isUndefined(e)||e.unregister().then(function(){this.register()}.bind(this))}.bind(this))})),!0},e.prototype.saveSubscription=function(e){var t;t="subscriptionId"in e?e.subscriptionId:this.getSubscriptionId(e.endpoint);var s=Insider.fns.parse(Insider.fns.stringify(e)).keys||{},i=s.auth||"",r=s.p256dh||"";return this.setUserPermissionGranted({insdrSubsId:t,pushRequestSent:!0}),Insider.worker.pm({type:this.localStorage,message:{action:"read"},success:function(e){var s=Insider.fns.find(e,"key",this.webPushStorageKey,!0);this.migrationNeeded()||!Insider.fns.isEmptyArray(s)?this.saveSubscriptionId(t,i,r,"update"):this.saveSubscriptionId(t,i,r,"insert")}.bind(this)}),!0},e.prototype.saveSubscriptionId=function(e,t,s,i){return this.sendRequest({url:this.tokenCollectorUrl,data:{token:e,authToken:t,p256DH:s,isNativeOptIn:1,browser:Insider.browser.getBrowserNameForWebPushToken(),userId:Insider.getUserId(),pageUrl:window.location.href,language:Insider.systemRules.call("getLang"),partner:this.partnerName,method:i},headers:{partner:this.partnerName}},function(){var t=Number(Insider.webPushState.nativeOptInCookieSettings.permissionAllowExpireDay);this.addToStorage("push-request-sent","true",t),this.addToStorage(this.storagePayloadComplete,"true",t),this.addToStorage(this.storageName,e,t),this.addToStorage(this.registeredWorkerPath,this.swPath,t),this.addToStorage(this.storageSubscriptionCreateDate,(new Date).getTime(),t)}.bind(this)),this.sendRequest({url:this.hitApiUrl,data:Insider.fns.encode(Insider.fns.stringify({version:"1.0",partner_name:this.partnerName,user_id:Insider.getUserId(),event:"user",webpush_optin:!0,webpush_token:e,webpush_language:Insider.systemRules.call("getLang"),device_type:Insider.browser.getDeviceType()})),headers:{}}),!0},e.prototype.setUserPermissionGranted=function(e){return Insider.fns.pm({target:window.top,type:"setUserPermissionGranted",message:e}),!0},e.prototype.getSubscriptionId=function(e){return e.split("/").pop()},e.prototype.instantSubscribe=function(e){var t;return e.installing?t=e.installing:e.waiting?t=e.waiting:e.active&&(t=e.active),!(!t||"activated"!==t.state||(this.subscribe(e),0))},e.prototype.migrationNeeded=function(){var e=this.checkFromStorage(this.storagePayloadComplete,"true"),t=Insider.webPushState.nativeOptInSDKCustomPath&&!Insider.storage.get("migratedSDK","cookie",!0)&&e,s=!e&&this.getCookie(this.storageName);return t||s},e.prototype.setCookieOnWorker=function(e,t,s){return Insider.worker.pm({type:"setCookie",message:{name:e,value:t,options:{path:"/",expires:s,domain:this.partnerName+".api.useinsider.com"}}}),!0},e.prototype.getCookie=function(e){return this.cookies[e]},e.prototype.addToStorage=function(e,t,s){return this.checkFromStorage(e,t)?(this.removeStorage(e),!1):(this.setCookieOnWorker(e,t,s),!0)},e.prototype.removeStorage=function(e){return!!this.getCookie(e)&&(this.setCookieOnWorker(e,"",-1),!0)},e.prototype.checkFromStorage=function(e,t){return this.getCookie(e)==t},e.prototype.convertVapidKeyToInt8Array=function(){for(var e=this.VAPIDPublicKey,t=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),s=window.atob(t),i=new Uint8Array(s.length),r=0;r<s.length;++r)i[r]=s.charCodeAt(r);return i},e.prototype.sendRequest=function(e,t){return Insider.request.post({url:e.url,data:e.data,headers:e.headers,success:function(){(t||Insider.fns.noop)()},error:function(e,t){this.debug&&console.log(t),this.handleException(t)}.bind(this)}),!0},e.prototype.sendLogToTokenCollector=function(e){const t=Insider.storage.get(this.webPushStorageKey);return this.sendRequest({url:this.tokenCollectorUrl,headers:{"Content-Type":"application/json",partner:this.partnerName},data:Insider.fns.stringify({method:"swRegistrationError",userId:Insider.getUserId(),token:t?t.token:"-",language:t?t.language:"-",browser:Insider.browser.getBrowserNameForWebPushToken(),pageUrl:window.location.href,partner:this.partnerName,error:e,userAgent:window.navigator.userAgent})}),!0},e.prototype.isEqualToLastError=function(e){return Insider.fns.compareAsString(this.getLastSwRegistrationError(),e)},e.prototype.getLastSwRegistrationError=function(){return Insider.storage.get(this.lastSwRegistrationError)||""},e.prototype.setLastSwRegistrationError=function(e){return Insider.storage.set({name:this.lastSwRegistrationError,value:e,expires:7}),!0},(new e).initialize()}();